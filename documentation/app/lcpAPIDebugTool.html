<html>
<head>
<title> LCP API Debug Tool </title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/hmac-sha1.js"></script>
<script src="https://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha1.js"></script>
<script src="https://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-base64-min.js"></script>
<script>
var defaultCurlTagStart="<pre class=\"embedcurl\" width=\"620\">"
var defaultCurlTagEnd="</pre>"
function randomString(len, charSet) {
    charSet = charSet || 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var randomString = '';
    for (var i = 0; i < len; i++) {
    	var randomPoz = Math.floor(Math.random() * charSet.length);
    	randomString += charSet.substring(randomPoz,randomPoz+1);
    }
    return randomString;
}

function getLCPAuthHeader(macId, macKey, method, server,path,data) {
	var d = new Date();
	var n = d.getTime()+"";
	var ts = n.substring(0, n.length-3);
	var nonce=randomString(8);
	var ext = "";
	if (method != "GET" && data.length > 0) {
		ext = CryptoJS.SHA1("application/json"+data);
	}
	macKey = macKey.replace(new RegExp("-", 'g'), "+").replace(new RegExp("_", 'g'), "/");
	var normalizedRequestString = ts+"\n"+nonce+"\n"+method+"\n"+path+"\n"+server+"\n443\n"+ext+"\n";
	var secret = CryptoJS.enc.Base64.parse(macKey);
	var mac=CryptoJS.HmacSHA1(normalizedRequestString, secret).toString(CryptoJS.enc.Base64);
	var header="MAC id=\""+macId+"\", ts=\""+ts+"\", nonce=\""+nonce+"\", ext=\""+ext+"\", mac=\""+mac+"\"";
	return header;
}

function updateCurlStyle() {
    var els = document.getElementsByClassName('embedcurl');
    for (var i = 0; i < els.length; i) {
        var id = Math.random().toString(36).substr(2, 5);
        var t = els[i].textContent;
        var fr = document.createElement("iframe");
        width = els[i].getAttribute("width") || 500;
        var h = (typeof __base_url != 'undefined') ? __base_url : "https://www.embedcurl.com/";
        url = h + "view?curl=" + window.btoa(unescape(encodeURIComponent(t)));
        if (width) {
            url += "&width=" + width;
        }
        var d = els[i].getAttribute("title");
        if (d) {
            url += "&title=" + d;
        }
        url += "&id=" + id;
        fr.setAttribute("src", url);
        fr.frameBorder = '0';
        fr.height = 100;
        fr.width = width;
        fr.id = id;
        fr.scrolling = "no";
        els[i].parentNode.replaceChild(fr, els[i]);
    }
    window.addEventListener('message', function (e) {
        document.getElementById(e.data[0]).height = e.data[1] + 18;
    }, false);
}
/**
   * Run initializations on web app load.
   */
  $(function() {
    //request token
    $('#macKey,#macId,#server,#path,#method,#data').keyup(function () {
        var data = "";
        if ($('#method').val() != "GET" && $('#data').val().length > 0) {
        	data = $('#data').val().replace(new RegExp("\n", 'g'), "").replace(new RegExp("\r", 'g'), "");
        }
        var authorization = getLCPAuthHeader($('#macId').val(),$('#macKey').val(),$('#method').val(),$('#server').val(),$('#path').val(),data);
        $('#data_access_curl').html(defaultCurlTagStart + "curl -i -X " + $('#method').val() + " https://" + $('#server').val() + $('#path').val() + " -H 'Content-Type: application/json' -H 'Authorization: " + authorization + "'"+(data.length > 0 ? " -d '"+data+"'" : "") + defaultCurlTagEnd);
    	updateCurlStyle();
    });
  });
</script>
</head>
<body>
    <table class="inputDataTable">
                <colgroup>
                    <col style="text-align: right;"/>
                    <col/>
                </colgroup>
                <tr>
                    <td>Mac Key</td>
                    <td><input type="text" id="macKey" /></td>
                </tr>
                <tr>
                    <td>Mac Id</td>
                    <td><input type="text" id="macId" /></td>
                </tr>
                <tr>
                    <td>Server</td>
                    <td><select id="server"><option value="staging.lcp.points.com">Staging</option><option value="lcp.points.com">Production</option></select></td>
                </tr>
                <tr>
                    <td>Path</td>
                    <td><input type="text" id="path" /></td>
                </tr>
                <tr>
                    <td>Method</td>
                    <td><select id="method"><option value="GET">GET</option><option value="POST">POST</option><option value="PUT">PUT</option></select></td>
                </tr>
                <tr>
                	<td>Body</td>
                    <td><textarea id="data" cols="50" rows="20"></textarea></td>
                </tr>
             </table>
            <br/>
			            <br/>
			            <h2>API request CURL:</h2>
            <p id="data_access_curl" style="height: 100px;"></p>

  </body>


</html>